{% extends "shared/layout.jinja" %}

{% block title %}
Notifications
{% endblock %}

{% set fetch_roster_btn_id = "fetch-roster-btn" %}
{% set fetch_roster_dummy_input_id = "fetch-roster-dummy-input" %}
{# messages and status are combined for fetch roster #}
{% set fetch_roster_status_id = "fetch-roster-status" %}

{% set flashed = get_flashed_by_categories() %}

{% block body %}
<div id="notifications-body" class="container-fluid">
  <h2>Notifications</h2>

  <div class="row mb-2">
    <div class="col">
      <h4>Teams Roster</h4>
      <div class="mb-2">
        The roster in the TMS spreadsheet will be fetched whenever the "Fetch
        Roster" button is pressed. There should be a worksheet called
        <code>{{ roster_worksheet_name }}</code> with the full teams roster.
        (Note: the header columns are case insensitive and must be unique.)
        {# TODO: add a help page with the full requirements of the worksheet #}
      </div>
      {% if roster_last_fetched_time is not none %}
      {# assume there is a roster #}
      <div class="mb-2">
        You can view the full roster here:
        <a href="{{ url_for('view_full_roster') }}">Full Roster</a>
      </div>
      {% endif %}
      <div class="mb-2">
        {# no "mb-2" so the error messages are close to the button #}
        <div class="row align-items-center">
          <div class="col-auto">
            <button id="{{ fetch_roster_btn_id }}" class="btn btn-success">
              Fetch Roster
            </button>
          </div>
          <div id="{{ fetch_roster_status_id }}" class="col-auto">
            {% for message in flashed["fetch-roster"] %}
            {% call macros.bs_alert_sm("success", classes="me-2") %}
            {{ message }}
            {% endcall %}
            {% endfor %}
          </div>
        </div>
        <div class="row mb-2">
          <div class="col">
            <input type="hidden" id="{{ fetch_roster_dummy_input_id }}" />
            <div
              id="{{ fetch_roster_dummy_input_id }}-invalid"
              class="invalid-feedback"
            ></div>
          </div>
        </div>
        {% if roster_last_fetched_time is not none %}
        <div class="row mt-3 mb-2">
          {# alerts have weird spacings, so need to also have "mt-3" #}
          <div class="col-auto">
            {% call macros.bs_alert_sm("warning", dismissible=false) %}
            Warning: Fetching again will override the current roster.
            {% endcall %}
          </div>
        </div>
        {% endif %}
        <div class="row mb-2">
          <div class="col">
            Last fetched:
            {% if roster_last_fetched_time is none %}
            <em class="text-muted">never</em>
            {% else %}
            {{ roster_last_fetched_time }}
            {% if has_fetch_logs %}
            <a href="{{ url_for('fetch_roster_logs') }}">(logs)</a>
            {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
  function handleFetchRosterClicked() {
    const FETCHING = 'Fetching...';

    if ($('#{{ fetch_roster_status_id }}').html().trim() === FETCHING) {
      // currently fetching; ignore click
      return;
    }

    clearInvalid('{{ fetch_roster_dummy_input_id }}');

    $('#{{ fetch_roster_status_id }}').html(FETCHING);
    ajaxRequest('POST', '{{ url_for("fetch_roster") }}', {
      success: (response, status, jqXHR) => {
        if (response.success) {
          // reload the page
          location.reload();
        } else {
          // clear the status
          $('#{{ fetch_roster_status_id }}').html('');
          // some failure
          setInvalid(
            '{{ fetch_roster_dummy_input_id }}',
            response.reason ?? 'Unknown error: please try again'
          );
        }
      },
      error: (jqXHR, status, errorThrown) => {
        // clear the status
        $('#{{ fetch_roster_status_id }}').html('');
        setInvalid('{{ fetch_roster_dummy_input_id }}', jqXHR.statusText);
      },
    });
  }

  $(document).ready(() => {
    // Fetch roster
    $('#{{ fetch_roster_btn_id }}').click((event) => {
      handleFetchRosterClicked();
    });
    // clear the flashed text after 60 seconds
    clearElementAfter('{{ fetch_roster_status_id }}', 60);
  });
</script>
{% endblock %}
