{% extends "shared/layout.jinja" %}

{% block title %}
Notifications
{% endblock %}

{% set fetch_roster_btn_id = "fetch-roster-btn" %}
{% set fetch_roster_dummy_input_id = "fetch-roster-dummy-input" %}
{% set fetch_roster_messages_id = "fetch-roster-messages" %}
{% set clear_roster_btn_id = "clear-roster-btn" %}

{% set match_numbers_input_id = "match-numbers-input" %}
{% set fetch_matches_btn_id = "fetch-matches-btn" %}
{% set set_last_matches_query_btn_id = "set-last-matches-query-btn" %}

{% set fetch_matches_warnings_id = "fetch-matches-warnings" %}
{% set fetch_matches_warning_alert_id = "fetch-matches-warning-alert" %}

{% set matches_fetch_info_id = "matches-fetch-info" %}
{% set last_matches_query_id = "last-matches-query" %}
{% set refresh_matches_btn_id = "refresh-matches-btn" %}
{% set refresh_matches_status_id = "refresh-matches-status" %}

{% set matches_info_table_id = "matches-info-table" %}
{% set delete_all_matches_btn_id = "delete-all-matches-btn" %}
{% set no_matches_row_id = "no-matches-row" %}

{% set send_notif_btn_id = "send-notification-btn" %}

{% set flashed = get_flashed_by_categories(subcategories=true) %}

{% block body %}
<div id="notifications-body" class="container-fluid">
  <h2>Notifications</h2>
  <div id="teams-roster-section" class="row mb-2">
    <div class="col">
      <h4>Teams Roster</h4>
      <div class="mb-2">
        The roster in the TMS spreadsheet will be fetched whenever the "Fetch
        Roster" button is pressed. There should be a worksheet called
        <code>{{ roster_worksheet_name }}</code> with the full teams roster.
        (Note: the header columns are case insensitive and must be unique.)
        {# TODO: add a help page with the full requirements of the worksheet #}
      </div>
      {% if roster_last_fetched_time is not none %}
      {# assume there is a roster #}
      <div class="mb-2">
        You can view the full roster here:
        <a href="{{ url_for('view_full_roster') }}">Full Roster</a>
      </div>
      {% endif %}
      <div class="mb-2">
        <div class="row">
          <div class="col-auto">
            {{ macros.loading_btn(
                 fetch_roster_btn_id, "success", "Fetch Roster", "Fetching..."
               )
            }}
          </div>
          {% if roster_last_fetched_time is not none %}
          {# alerts have weird spacings, so need to also have "mt-2". add "mb-2"
             for additional spacing when this div wraps.
           #}
          <div class="col-auto my-2">
            {% call macros.bs_alert_sm("warning", dismissible=false) %}
            <strong>Warning:</strong> Fetching again will override the current
            roster.
            {% endcall %}
          </div>
          {% endif %}
        </div>
        <div class="row mb-2">
          <div class="col">
            <input type="hidden" id="{{ fetch_roster_dummy_input_id }}" />
            <div
              id="{{ fetch_roster_dummy_input_id }}-invalid"
              class="invalid-feedback"
            ></div>
          </div>
        </div>
        <div class="row">
          <div id="{{ fetch_roster_messages_id }}" class="col-auto">
            {% for accent, messages in flashed["fetch-roster"].items() %}
            {% for message in messages %}
            {% call macros.bs_alert(accent) %}
            {{ message }}
            {% endcall %}
            {% endfor %}
            {% endfor %}
          </div>
        </div>
        {% if roster_last_fetched_time is not none %}
        <div class="row mb-2">
          <div class="col-auto">
            {{ macros.confirm_btn(
                 clear_roster_btn_id,
                 "Clear Roster",
                 "clear the full roster",
                 loading_text="Clearing...",
               )
            }}
          </div>
        </div>
        {% endif %}
        <div class="row mb-2">
          <div class="col">
            Last fetched:
            {% if roster_last_fetched_time is none %}
            <em class="text-muted">never</em>
            {% else %}
            {{ roster_last_fetched_time }}
            {% if has_fetch_logs %}
            <a href="{{ url_for('fetch_roster_logs') }}">(logs)</a>
            {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="send-notifications-section" class="row mb-2">
    <div class="col">
      <div class="row">
        <div class="col">
          <h4>Send Match Notifications</h4>
          <div class="mb-2">
            Enter the match numbers below that you want to send notifications
            for. The matches will keep being added to the table until the "Send
            Notification" button is pressed.
          </div>
          <div class="mb-2">
            The TMS spreadsheet should have a worksheet called
            <code>{{ matches_worksheet_name }}</code> which will be queried to
            find the competing teams for each match.
          </div>
        </div>
      </div>
      <div class="row mb-2">
        {# want the switch back to auto somewhere between xs and sm, but not
           possible without customizing the breakpoints
         #}
        <div class="col-xs-auto col-md col-xl-auto">
          <div class="row">
            <label
              for="{{ match_numbers_input_id }}"
              class="col-auto col-form-label pe-0"
            >
              Add Matches
            </label>
            <div class="col pe-0">
              <input
                type="text"
                id="{{ match_numbers_input_id }}"
                class="form-control"
                placeholder="e.g., 101-104"
              />
              <div
                id="{{ match_numbers_input_id }}-invalid"
                class="invalid-feedback"
              ></div>
              <div class="form-text">
                The match numbers should be separated by spaces or commas. You
                may use dashes for match number ranges.
              </div>
            </div>
          </div>
        </div>
        <div class="col-auto pe-0">
          {{ macros.loading_btn(
               fetch_matches_btn_id,
               "success",
               "Fetch Matches Info",
               "Fetching...",
             )
          }}
        </div>
        <div class="col-auto">
          <button
            type="button"
            id="{{ set_last_matches_query_btn_id }}"
            {% with hidden = "d-none" if last_matches_query is none else "" %}
            class="btn btn btn-secondary {{ hidden }}"
            {% endwith %}
            lastquery="{{ last_matches_query or '' }}"
          >
            Last Query
          </button>
        </div>
      </div>
      <div class="row mb-2">
        <div class="col">
          <div id="{{ fetch_matches_warnings_id }}"></div>
        </div>
      </div>
      <div class="row mb-2">
        <div class="col">
          <div id="{{ matches_fetch_info_id }}" class="d-none">
            Matches query:
            <span id="{{ last_matches_query_id }}" class="me-1"></span>
            {% call macros.loading_btn(
                 refresh_matches_btn_id,
                 "outline-success",
                 "Refresh",
                 "Refreshing...",
                 classes="btn-sm me-1",
               )
            %}
            disabled
            {% endcall %}
            <span
              id="{{ refresh_matches_status_id }}"
              class="text-danger d-none"
            ></span>
          </div>
        </div>
      </div>
      <div class="row mb-2">
        <div class="col table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead class="align-middle">
              <tr>
                <th class="table-sm-col">Match</th>
                <th class="table-sm-col">Division</th>
                <th class="table-sm-col">Round</th>
                <th class="table-sm-col">Status</th>
                <th class="table-primary">Blue Team</th>
                <th class="table-danger">Red Team</th>
                <th class="table-sm-col">Valid</th>
                <th class="table-sm-col text-center">
                  <button
                    type="button"
                    id="{{ delete_all_matches_btn_id }}"
                    class="btn btn-sm btn-danger"
                    disabled
                  >
                    Delete All
                  </button>
                </th>
              </tr>
            </thead>
            <tbody id="{{ matches_info_table_id }}">
              <tr id="{{ no_matches_row_id }}">
                <td colspan="7">No matches</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="row">
        <div class="col">
          {# button currently does nothing #}
          {{ macros.loading_btn(
               send_notif_btn_id, "primary", "Send Notification", "Sending..."
             )
          }}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
  function handleFetchRosterClicked() {
    if (isButtonLoading('{{ fetch_roster_btn_id }}')) {
      // currently fetching; ignore click
      return;
    }

    // clear messages
    $('#{{ fetch_roster_messages_id }}').html('');
    clearInvalid('{{ fetch_roster_dummy_input_id }}');

    setButtonLoading('{{ fetch_roster_btn_id }}');
    ajaxRequest('POST', '{{ url_for("fetch_roster") }}', {
      success: (response, status, jqXHR) => {
        if (response.success) {
          // reload the page
          location.reload();
        } else {
          // some failure
          stopButtonLoading('{{ fetch_roster_btn_id }}');
          setInvalid(
            '{{ fetch_roster_dummy_input_id }}',
            response.reason ?? 'Unknown error: please try again'
          );
        }
      },
      error: (jqXHR, status, errorThrown) => {
        stopButtonLoading('{{ fetch_roster_btn_id }}');
        setInvalid('{{ fetch_roster_dummy_input_id }}', jqXHR.statusText);
      },
    });
  }

  function handleClearRosterClicked() {
    if (isButtonLoading('{{ clear_roster_btn_id }}')) {
      // currently clearing; ignore click
      return;
    }

    // clear messages
    $('#{{ fetch_roster_messages_id }}').html('');

    setButtonLoading('{{ clear_roster_btn_id }}');
    // just reload once the clearing is done
    ajaxRequest('DELETE', '{{ url_for("fetch_roster") }}');
  }

  function getCurrentMatchRows({ onlyNumbers = false } = {}) {
    // get the match data of all the rows in the table
    const currentMatches = [];
    $('.match-row').each((index, element) => {
      const matchDataStr = getAttr(element.id, 'matchdata');
      if (matchDataStr === '') return;
      let matchData;
      try {
        matchData = JSON.parse(matchDataStr);
      } catch (e) {
        // not in valid json format; ignore
        return;
      }
      if (onlyNumbers) {
        currentMatches.push(matchData.number);
      } else {
        currentMatches.push(matchData);
      }
    });
    return currentMatches;
  }

  function handleSetLastMatchesQueryClicked() {
    const lastMatchesQuery = getAttr(
      '{{ set_last_matches_query_btn_id }}',
      'lastquery'
    );
    if (lastMatchesQuery === '') {
      return;
    }
    // set match numbers input value
    $('#{{ match_numbers_input_id }}').val(lastMatchesQuery);
  }

  function resetMatchesTable({ clearWarnings = true } = {}) {
    // disable the delete all button
    $('#{{ delete_all_matches_btn_id }}').prop('disabled', true);
    if (clearWarnings) {
      // clear and hide the warnings
      $('#{{ fetch_matches_warnings_id }}').addClass('d-none').html('');
    }
    // hide the fetch info
    $('#{{ matches_fetch_info_id }}').addClass('d-none');
    $('#{{ last_matches_query_id }}').html('');
    $('#{{ refresh_matches_btn_id }}').prop('disabled', true); // just in case
    $('#{{ refresh_matches_status_id }}').addClass('d-none').html('');
    // clear the matches query input
    $('#{{ match_numbers_input_id }}').val('');
    // show the no matches row
    $('#{{ no_matches_row_id }}').removeClass('d-none');
    // delete all the other rows
    $('.match-row').remove();
  }

  function populateMatchInfoTable(response) {
    const $warningsDiv = $('#{{ fetch_matches_warnings_id }}');
    // clear warnings
    $warningsDiv.html('');
    // add warnings
    const warnings = response.warnings;
    if (warnings.length > 0) {
      // create warning alert
      $warningsDiv.html(
        bsAlert('<div><strong>Warnings:</strong></div>', 'warning', {
          textId: '{{ fetch_matches_warning_alert_id }}',
        })
      );
      // populate warnings
      const $alert = $('#{{ fetch_matches_warning_alert_id }}');
      for (const warning of warnings) {
        $alert.append(`<div>${warning}</div>`);
      }
    }
    const matchesRowsHtml = response['matches_rows_html'];
    if (matchesRowsHtml == null) {
      // no matches; reset table
      // there are possible warnings from above, so don't clear them
      resetMatchesTable({ clearWarnings: false });
      return;
    }
    const lastMatchesQuery = response['last_matches_query'];
    // show the fetch info
    $('#{{ refresh_matches_btn_id }}').prop('disabled', false);
    $('#{{ last_matches_query_id }}').html(lastMatchesQuery);
    $('#{{ matches_fetch_info_id }}').removeClass('d-none');
    // update last query button
    $('#{{ set_last_matches_query_btn_id }}')
      .removeClass('d-none')
      .attr('lastquery', lastMatchesQuery);
    // enable delete all button
    $('#{{ delete_all_matches_btn_id }}').prop('disabled', false);
    // clear the table
    $('.match-row').remove();
    // add the results to the table
    $('#{{ no_matches_row_id }}').addClass('d-none');
    $('#{{ matches_info_table_id }}').append(matchesRowsHtml);
  }

  function handleFetchMatchInfoClicked() {
    if (isButtonLoading('{{ fetch_matches_btn_id }}')) {
      // currently fetching; ignore the click
      return;
    }
    if (isButtonLoading('{{ refresh_matches_btn_id }}')) {
      // currently refreshing; ignore the click
      return;
    }

    clearInvalid('{{ match_numbers_input_id }}');
    $('#{{ refresh_matches_status_id }}').addClass('d-none').html('');

    const matchesQuery = getInputValue('{{ match_numbers_input_id }}');
    if (matchesQuery === '') {
      // Error: no match numbers given
      setInvalid(
        '{{ match_numbers_input_id }}',
        'Please enter a match number.'
      );
      return;
    }

    // get the current match numbers
    const currentMatchNumbers = getCurrentMatchRows({ onlyNumbers: true });
    const previousMatchesQuery = currentMatchNumbers.join(',');

    setButtonLoading('{{ fetch_matches_btn_id }}');
    ajaxRequest('GET', '{{ url_for("fetch_matches_info") }}', {
      data: { matches: matchesQuery, previous: previousMatchesQuery },
      success: (response, status, jqXHR) => {
        stopButtonLoading('{{ fetch_matches_btn_id }}');
        if (response.success) {
          // clear the input
          $('#{{ match_numbers_input_id }}').val('');
          populateMatchInfoTable(response);
        } else {
          // some failure
          setInvalid(
            '{{ match_numbers_input_id }}',
            response.reason ?? 'Unknown error: please try again'
          );
        }
      },
      error: (jqXHR, status, errorThrown) => {
        stopButtonLoading('{{ fetch_matches_btn_id }}');
        setInvalid('{{ match_numbers_input_id }}', jqXHR.statusText);
      },
    });
  }

  function refreshMatches() {
    const refreshStatusId = '#refresh-matches-status';

    if (isButtonLoading('{{ refresh_matches_btn_id }}')) {
      // currently refreshing; ignore the click
      return;
    }
    if (isButtonLoading('{{ fetch_matches_btn_id }}')) {
      // currently fetching; ignore the click
      return;
    }

    // clear the input and any errors
    $('#{{ match_numbers_input_id }}').val('');
    clearInvalid('{{ match_numbers_input_id }}');
    $('#{{ refresh_matches_status_id }}').addClass('d-none').html('');

    const currentMatchNumbers = getCurrentMatchRows({ onlyNumbers: true });
    if (currentMatchNumbers.length === 0) {
      // no matches; do nothing
      return;
    }
    const matchesQuery = currentMatchNumbers.join(',');

    setButtonLoading('{{ refresh_matches_btn_id }}');
    ajaxRequest('GET', '{{ url_for("fetch_matches_info") }}', {
      data: { matches: matchesQuery },
      success: (response, status, jqXHR) => {
        stopButtonLoading('{{ refresh_matches_btn_id }}');
        if (response.success) {
          populateMatchInfoTable(response);
        } else {
          // some failure
          $('#{{ refresh_matches_status_id }}')
            .removeClass('d-none')
            .html(response.reason ?? 'Unknown error: please try again');
        }
      },
      error: (jqXHR, status, errorThrown) => {
        stopButtonLoading('{{ refresh_matches_btn_id }}');
        $('#{{ refresh_matches_status_id }}')
          .removeClass('d-none')
          .html(jqXHR.statusText);
      },
    });
  }

  function toggleMatchTeamMembers(elementId) {
    const $membersDiv = $('#' + elementId);
    const $toggleButton = $('#toggle-' + elementId);
    if ($membersDiv.hasClass('d-none')) {
      // show
      $membersDiv.removeClass('d-none');
      $toggleButton.html('Hide Members');
    } else {
      // hide
      $membersDiv.addClass('d-none');
      $toggleButton.html('Show Members');
    }
  }

  function removeMatchRow(matchNumber) {
    const $matchRow = $('#match-' + matchNumber);
    if ($matchRow.length === 0) return;
    $matchRow.remove();

    // update the matches query
    const currentMatchNumbers = getCurrentMatchRows({ onlyNumbers: true });
    if (currentMatchNumbers.length === 0) {
      // no more matches
      resetMatchesTable();
      return;
    }
    const matchesQuery = currentMatchNumbers.join(',');

    // update the matches query
    ajaxRequest('GET', '{{ url_for("get_matches_query") }}', {
      data: { matches: matchesQuery },
      success: (response, status, jqXHR) => {
        if (response.success) {
          const cleanMatchesQuery = response['matches_query'];
          // update matches query text
          $('#{{ last_matches_query_id }}').html(cleanMatchesQuery);
          // update last query button
          $('#{{ set_last_matches_query_btn_id }}').attr(
            'lastquery',
            cleanMatchesQuery
          );
        }
        // if error, do nothing
      },
      error: (jqXHR, status, errorThrown) => {
        // do nothing
      },
    });
  }

  $(document).ready(() => {
    // Fetch roster
    $('#{{ fetch_roster_btn_id }}').click((event) => {
      handleFetchRosterClicked();
    });
    $('#{{ clear_roster_btn_id }}').click((event) => {
      handleClearRosterClicked();
    });
    // clear the flashed text after 60 seconds
    clearElementAfter('{{ fetch_roster_messages_id }}', 60);

    // Fetch match info
    $('#{{ match_numbers_input_id }}').onEnterKeyPress((event) => {
      $('#{{ fetch_matches_btn_id }}').click();
    });
    $('#{{ fetch_matches_btn_id }}').click((event) => {
      handleFetchMatchInfoClicked();
    });
    $('#{{ set_last_matches_query_btn_id }}').click((event) => {
      handleSetLastMatchesQueryClicked();
    });
    $('#{{ refresh_matches_btn_id }}').click((event) => {
      refreshMatches();
    });
    $('#{{ delete_all_matches_btn_id }}').click((event) => {
      resetMatchesTable();
    });
  });
</script>
{% endblock %}
